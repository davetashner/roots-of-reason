#!/usr/bin/env bash
# ror — Roots of Reason developer CLI
# Usage: ror <command> [options]
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

# --- Helpers ---
info()  { printf "${CYAN}▸${RESET} %s\n" "$*"; }
ok()    { printf "${GREEN}✔${RESET} %s\n" "$*"; }
warn()  { printf "${YELLOW}⚠${RESET} %s\n" "$*"; }
err()   { printf "${RED}✖${RESET} %s\n" "$*" >&2; }

# --- Godot binary detection ---
find_godot() {
    if [[ -n "${GODOT_BIN:-}" ]] && [[ -x "$GODOT_BIN" ]]; then
        echo "$GODOT_BIN"
        return
    fi
    # Common locations on macOS
    local candidates=(
        "/Applications/Godot.app/Contents/MacOS/Godot"
        "/Applications/Godot_mono.app/Contents/MacOS/Godot"
        "$HOME/Applications/Godot.app/Contents/MacOS/Godot"
    )
    # Also check PATH
    if command -v godot &>/dev/null; then
        command -v godot
        return
    fi
    for bin in "${candidates[@]}"; do
        if [[ -x "$bin" ]]; then
            echo "$bin"
            return
        fi
    done
    return 1
}

# --- gdtoolkit venv management ---
VENV_DIR="$PROJECT_ROOT/.venv-gdtoolkit"

ensure_gdtoolkit() {
    if [[ -x "$VENV_DIR/bin/gdlint" ]] && [[ -x "$VENV_DIR/bin/gdformat" ]]; then
        return
    fi
    info "Setting up gdtoolkit virtualenv at $VENV_DIR ..."
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip" install --quiet "gdtoolkit==4.*"
    ok "gdtoolkit installed"
}

# ==================== test ====================
cmd_test() {
    local godot
    if ! godot=$(find_godot); then
        err "Godot binary not found."
        echo "  Set GODOT_BIN or install Godot to a standard location."
        exit 1
    fi
    info "Using Godot: $godot"

    local test_args=()
    if [[ $# -gt 0 ]]; then
        # Convert filesystem paths to res:// paths for GdUnit4
        for arg in "$@"; do
            if [[ "$arg" == tests/* ]] || [[ "$arg" == ./tests/* ]]; then
                arg="${arg#./}"
                test_args+=("--add" "res://$arg")
            elif [[ "$arg" == res://* ]]; then
                test_args+=("--add" "$arg")
            else
                test_args+=("$arg")
            fi
        done
    else
        test_args=("--add" "res://tests")
    fi

    cd "$PROJECT_ROOT"

    # Ensure .godot cache is fresh (needed for class resolution)
    info "Importing project resources ..."
    "$godot" --headless --path . --import >/dev/null 2>&1 || true

    printf "${BOLD}Running GdUnit4 tests …${RESET}\n"
    "$godot" --path . -s -d res://addons/gdUnit4/bin/GdUnitCmdTool.gd "${test_args[@]}"
    local exit_code=$?

    # Copy logs silently
    "$godot" --headless --path . --quiet -s res://addons/gdUnit4/bin/GdUnitCopyLog.gd "${test_args[@]}" >/dev/null 2>&1 || true

    echo ""
    if [[ $exit_code -eq 0 ]]; then
        ok "All tests passed"
    else
        err "Tests failed (exit code $exit_code)"
    fi
    return $exit_code
}

# ==================== lint ====================
cmd_lint() {
    ensure_gdtoolkit
    local gdlint="$VENV_DIR/bin/gdlint"
    local gdformat="$VENV_DIR/bin/gdformat"
    local fix=false
    local targets=("scripts/" "tests/")

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --fix) fix=true; shift ;;
            *)     targets=("$@"); break ;;
        esac
    done

    cd "$PROJECT_ROOT"
    local exit_code=0

    if $fix; then
        info "Auto-formatting with gdformat ..."
        "$gdformat" "${targets[@]}" || true
        ok "Formatting complete"
    fi

    printf "${BOLD}Running gdlint …${RESET}\n"
    if "$gdlint" "${targets[@]}"; then
        ok "Lint passed"
    else
        err "Lint issues found"
        exit_code=1
    fi

    if ! $fix; then
        printf "${BOLD}Checking format …${RESET}\n"
        if "$gdformat" --check "${targets[@]}"; then
            ok "Format check passed"
        else
            warn "Format issues found — run 'ror lint --fix' to auto-format"
            exit_code=1
        fi
    fi

    return $exit_code
}

# ==================== help ====================
cmd_help() {
    cat <<EOF
${BOLD}ror${RESET} — Roots of Reason developer CLI

${BOLD}USAGE${RESET}
  ror <command> [options]

${BOLD}COMMANDS${RESET}
  test [path...]      Run GdUnit4 tests (headless)
                        ror test                    — run all tests
                        ror test tests/autoloads/   — run a subset
  lint [--fix] [path] Run gdlint + gdformat check
                        ror lint                    — check scripts/ tests/
                        ror lint --fix              — auto-format then lint
  help                Show this help message

${BOLD}ENVIRONMENT${RESET}
  GODOT_BIN           Path to Godot binary (auto-detected if unset)
EOF
}

# ==================== main ====================
case "${1:-help}" in
    test)  shift; cmd_test "$@" ;;
    lint)  shift; cmd_lint "$@" ;;
    help|--help|-h) cmd_help ;;
    *)
        err "Unknown command: $1"
        cmd_help
        exit 1
        ;;
esac
