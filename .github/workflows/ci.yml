name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"

      - name: Install gdtoolkit
        run: pip install "gdtoolkit==4.5.0"

      - name: Run gdlint
        run: gdlint scripts/ tests/

      - name: Check gdformat
        run: gdformat --check scripts/ tests/

  validate:
    name: Data & Asset Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"

      - name: Validate JSON data schemas
        run: python3 tools/data_check.py

      - name: Validate assets (ADR-008)
        run: python3 tools/validate_assets.py

      - name: Scan for secrets
        run: |
          pip install detect-secrets
          detect-secrets scan --all-files \
            --exclude-files '\.godot/|addons/|\.git/' \
            --exclude-files '\.png$|\.svg$|\.wav$|\.ogg$|\.tres$|\.tscn$' \
            | python3 -c "
          import sys, json
          results = json.load(sys.stdin).get('results', {})
          total = sum(len(v) for v in results.values())
          if total:
              for path, secrets in results.items():
                  for s in secrets:
                      print(f'::error file={path},line={s[\"line_number\"]}::{s[\"type\"]}: potential secret detected')
              sys.exit(1)
          print('No secrets detected')
          "

  bead-check:
    name: Bead Traceability
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check PR body for bead references
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: python3 tools/check_pr_beads.py

  python-tests:
    name: Python Tool Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: pip install pytest

      - name: Run Python tool tests
        run: pytest tests/tools/ -v

  test:
    name: GdUnit4 Tests
    runs-on: ubuntu-latest
    needs: [lint, validate]
    env:
      GODOT_VERSION: "4.6"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Cache Godot binary
        id: cache-godot
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: /usr/local/bin/godot
          key: godot-${{ env.GODOT_VERSION }}-linux-x86_64

      - name: Install Godot
        if: steps.cache-godot.outputs.cache-hit != 'true'
        run: |
          wget -q "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
          unzip -q "Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
          sudo mv "Godot_v${GODOT_VERSION}-stable_linux.x86_64" /usr/local/bin/godot

      - name: Run GdUnit4 tests (4 parallel shards)
        timeout-minutes: 10
        env:
          GODOT_BIN: /usr/local/bin/godot
        run: ./tools/ror test --jobs=4

      - name: Merge shard reports
        if: always()
        run: |
          # Collect all JUnit XML results from shard directories
          mkdir -p reports/merged
          for f in reports/shard_*/results.xml; do
            [ -f "$f" ] && cp "$f" "reports/merged/$(basename $(dirname $f))_results.xml"
          done
          # Fall back to single report if no shards
          if [ -z "$(ls reports/merged/ 2>/dev/null)" ] && [ -f reports/report_1/results.xml ]; then
            cp reports/report_1/results.xml reports/merged/results.xml
          fi

      - name: Publish test report
        if: always()
        uses: mikepenz/action-junit-report@3585e9575db828022551b4231f165eb59a0e74e3 # v5
        with:
          report_paths: reports/merged/*.xml
          check_name: test-report.xml

  coverage:
    name: Test-File Coverage
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run coverage gate
        id: coverage
        run: |
          set +e
          output=$(tools/ror coverage --json --threshold 74)
          exit_code=$?
          set -e
          echo "$output"

          # Single-pass JSON parsing
          eval "$(echo "$output" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          print(f'total={d[\"total\"]}')
          print(f'covered={d[\"covered\"]}')
          print(f'pct={d[\"percentage\"]}')
          print(f'pass_val={str(d[\"pass\"]).lower()}')
          ")"

          uncovered=$(echo "$output" | python3 -c "
          import sys, json
          for f in json.load(sys.stdin)['uncovered_files']:
              print(f'- \`{f}\`')
          ")

          {
            echo "summary<<EOF"
            echo "## Test-File Coverage: ${covered}/${total} (${pct}%)"
            echo ""
            if [ -n "$uncovered" ]; then
              echo "<details><summary>Uncovered scripts</summary>"
              echo ""
              echo "$uncovered"
              echo ""
              echo "</details>"
              echo ""
            fi
            if [ "$pass_val" = "true" ]; then
              echo ":white_check_mark: Coverage gate **passed** (threshold: 74%)"
            else
              echo ":x: Coverage gate **failed** (threshold: 74%)"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          exit $exit_code
        continue-on-error: true

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: coverage
          message: ${{ steps.coverage.outputs.summary }}

      - name: Fail if coverage below threshold
        if: steps.coverage.outcome == 'failure'
        run: |
          echo "::error::Test-file coverage is below threshold"
          exit 1
