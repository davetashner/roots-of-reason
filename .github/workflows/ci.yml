name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Install gdtoolkit
        run: pip install "gdtoolkit==4.5.0"

      - name: Run gdlint
        run: gdlint scripts/ tests/

      - name: Check gdformat
        run: gdformat --check scripts/ tests/

  validate:
    name: Data & Asset Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Validate JSON data schemas
        run: python3 tools/data_check.py

      - name: Validate assets (ADR-008)
        run: python3 tools/validate_assets.py

      - name: Scan for secrets
        run: |
          pip install detect-secrets
          detect-secrets scan --all-files \
            --exclude-files '\.godot/|addons/|\.git/' \
            --exclude-files '\.png$|\.svg$|\.wav$|\.ogg$|\.tres$|\.tscn$' \
            | python3 -c "
          import sys, json
          results = json.load(sys.stdin).get('results', {})
          total = sum(len(v) for v in results.values())
          if total:
              for path, secrets in results.items():
                  for s in secrets:
                      print(f'::error file={path},line={s[\"line_number\"]}::{s[\"type\"]}: potential secret detected')
              sys.exit(1)
          print('No secrets detected')
          "

  python-tests:
    name: Python Tool Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: pip install pytest

      - name: Run Python tool tests
        run: pytest tests/tools/ -v

  test:
    name: GdUnit4 Tests
    runs-on: ubuntu-latest
    needs: [lint, validate]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run GdUnit4 tests
        uses: godot-gdunit-labs/gdUnit4-action@b07efbad7ebb4399455d34de4a0980dc49b26f16 # v1.3.0
        with:
          godot-version: "4.6"
          paths: res://tests
          timeout: 10

  coverage:
    name: Test-File Coverage
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run coverage gate
        id: coverage
        run: |
          set +e
          output=$(tools/ror coverage --json --threshold 18)
          exit_code=$?
          set -e
          echo "$output"

          # Single-pass JSON parsing
          eval "$(echo "$output" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          print(f'total={d[\"total\"]}')
          print(f'covered={d[\"covered\"]}')
          print(f'pct={d[\"percentage\"]}')
          print(f'pass_val={str(d[\"pass\"]).lower()}')
          ")"

          uncovered=$(echo "$output" | python3 -c "
          import sys, json
          for f in json.load(sys.stdin)['uncovered_files']:
              print(f'- \`{f}\`')
          ")

          {
            echo "summary<<EOF"
            echo "## Test-File Coverage: ${covered}/${total} (${pct}%)"
            echo ""
            if [ -n "$uncovered" ]; then
              echo "<details><summary>Uncovered scripts</summary>"
              echo ""
              echo "$uncovered"
              echo ""
              echo "</details>"
              echo ""
            fi
            if [ "$pass_val" = "true" ]; then
              echo ":white_check_mark: Coverage gate **passed** (threshold: 18%)"
            else
              echo ":x: Coverage gate **failed** (threshold: 18%)"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          exit $exit_code
        continue-on-error: true

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: coverage
          message: ${{ steps.coverage.outputs.summary }}

      - name: Fail if coverage below threshold
        if: steps.coverage.outcome == 'failure'
        run: |
          echo "::error::Test-file coverage is below threshold"
          exit 1
